# sdutils

开发神策数据前端应用的通用工具方法库。

## 安装

npm：

```shell
$ npm install git+http://gitlab.internal.sensorsdata.cn/components/utils/sdutils.git#semver:^0
```

在应用中使用：

```javascript
import sdutils from 'sdutils';
或者
import { checkRule } from 'sdutils'

// 调用工具方法
sdutils.diff();
```

### 工具方法列表

#### spreadObject(obj, selector)

以浅拷贝的方式展开对象。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| obj | `{Object}` | 要展开的对象 |
| selector | `{string}` | 结构选择符，如：data.config.list |

```javascript
const state = {
  result: {
    list: [11,22,33]
  }
};
const newState = {
  ...state
};

state.result === newState.result; // true

sdutils.spreadObject(newState, 'result.list');

state.result === newState.result; // false
state.result.list === newState.result.list; // false
```

#### arrayToObject(arr, key)

将数组转为以指定字段为 key 的 Object。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| arr | `{Array}` | 要转为 Object 的数组 |
| key | `{string}` | 以哪个字段为 key |

```javascript
const events = [
  {
    name: '$AppClick',
    cname: '$App 元素点击'
  },
  {
    name: '$AppViewScreen',
    cname: '$App 浏览页面'
  },
  {
    name: '$pageview',
    cname: '$Web 浏览页面'
  },
];

const eventsMap = sdutils.arrayToObject(events, 'name');

// {
//   '$AppClick': {
//     name: '$AppClick',
//     cname: '$App 元素点击'
//   },
//   '$AppViewScreen': {
//     name: '$AppViewScreen',
//     cname: '$App 浏览页面'
//   },
//   '$pageview': {
//     name: '$pageview',
//     cname: '$Web 浏览页面'
//   }
// }
```

#### diff(value1, value2)

比较两个值是否全等。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| value1 | `{*}` | 需要比较的值 |
| value2 | `{*}` | 需要比较的值 |

```javascript
const v1 = {
  result: {
    list: [11,22,33]
  }
};
const v2 = {
  result: {
    list: [11,22,33]
  }
};

v1 === v2; // false

sdutils.diff(v1, v2); // true
sdutils.diff(v1.result, v2.result); // true
```

#### numberSeparator(num)

为数字添加千位分隔符。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| num | `{number}` | 要添加分隔符的数字 |

```javascript
sdutils.numberSeparator(12345678); // '12,345,678'
```

#### cron

cron 方法库命名空间。

**cron.cronToText(str)**

cron 表达式转为文本。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| str | `{string}` | `cron` 表达式(eg: `'0 0 0 * * ? *'`) |

```javascript
sdutils.cron.cronToText('0 0 0 * * ? *'); // 每天 00:00
```

**cron.toCron(obj)**

定义的结构转为 `cron` 表达式。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| obj | `{Object}` | - |
| obj.unit | `{string}` | 单位 |
| obj.week | `{Array}` | 每周的第几天 |
| obj.day | `{Array}` | 每月的几号 |
| obj.time | `{Array}` | 几点几分 |

```javascript
sdutils.cron.toCron({
  unit: 'day',
  week: [],
  day: [],
  time: ['00:00', '01:00']
}) // '0 0 0,1 * * ? *' 每天 00:00，01:00
```

**cron.cronFormat(str)**

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| str | `{string}` | `cron` 表达式 |

返回值数据结构

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| obj | `{Object}` | - |
| obj.unit | `{string}` | 单位 |
| obj.week | `{Array}` | 每周的第几天 |
| obj.day | `{Array}` | 每月的几号 |
| obj.time | `{Array}` | 几点几分 |

```javascript

sdutils.cron.cronFormat('0 0 0 * * ? *') // 每天 00:00

/**
{
  unit: 'day',
  week: [],
  day: [],
  time: ['00:00']
}
**/
```

#### storage

localStorage 工具方法库命名空间。

**getAll()**

获取存储中的所有键值对，JSON 格式的键值会自动转为 `Object` 类型。

**getItem(key)**

返回键名对应的值。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| key | `{string}` | 键名，JSON 格式的键值会自动转为 `Object` 类型 |

**setItem(key, value)**

把键值对添加到存储中。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| key | `{string}` | 键名 |
| value | `{*}` | 键值，`Object` 类型的值会自动转为 JSON 字符串后存储 |

**removeItem(key)**

删除指定键名的值。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| key | `{string}` | 键名 |

**clear()**

清空存储中的所有键名。

**createLib(namespace)**

创建一个具有命名空间的 localStorage 工具方法库。

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| namespace | `{string}` | 命名空间 |

返回值：`{Object}` 新的 localStorage 工具方法库。

#### randomStr()

生成随机字符串。

```javascript
randomStr()
// 9s80b
```


#### formatProperties({ properties, userProperties } )

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| properties | `{Object}` | 事件属性,参考[API](http://api.sensorsdata.cn/#/%E5%85%83%E6%95%B0%E6%8D%AE/get_event__id__properties) |
| userProperties | `{Object}` | 用户属性，参考[API](http://api.sensorsdata.cn/?version=v2#/%5BSP%5D%20%E5%9F%BA%E6%9C%AC%E5%85%83%E6%95%B0%E6%8D%AE/getAllUserPropertiesWithDir)

```javascript
sdutils.formatProperties({
  properties: {

  },
  userProperties: {

  }
});

// 返回结构
// {
//   'event': {
//     label: '事件属性',
//     prefix: 'event',
//     properties: []
//   },
//   'session': {
//     label: "Session 属性",
//     prefix: 'session',
//     properties: []
//   },
//   'common': {
//     label: "用户属性",
//     prefix: 'user',
//     properties: []
//   },
//   'plans': {
//     label: "运营计划",
//     prefix: 'user',
//     properties: []
//   },
//   'user_tags': {
//     label: "标签",
//     prefix: 'user',
//     properties: []
//   },
//   'user_groups': {
//     label: "用户群",
//     prefix: 'user',
//     properties: []
//   }
// }
```

#### checkRules(data, isErrorReturn)

检查规则是否符合条件

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| data | `object` | 筛选器规则,参考[API](http://api.sensorsdata.cn/?version=v2_1_14#/%5BSP%5D%20%E6%A0%87%E7%AD%BE%E7%B3%BB%E7%BB%9F/createUserTag) |
| isErrorReturn | `boolean=` | 是否返回错误，默认为 true, 为 true 时返回的数据将带着 error 字段，为 false 时将数据中的不合规条件全部删除 |
```javascript
import { checkRules } from 'sdutils'
const { validate, resultValidate, data } = checkRules({})
```

#### permissionCreator(dataPermissionMap)

权限 API 与 UI 数据格式的互相转换工具方法生成器

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| dataPermissionMap | `object` | 数据权限的 ID 映射 |

```javascript
import { permissionCreator } from 'sdutils'
const dataPermissionMap = {
  1: 'event_filter',
  2: ['data_filter', 'user_filter']
}
const [ mapApiToUi, mapUiToApi ] = permissionCreator(dataPermissionMap)
```
##### mapApiToUi(permissionList, rolePermission, config, getDefaultValue)
API 数据转换为 UI 数据

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| permissionList | `array` | 所有权限 |
| rolePermission | `object=` | 当前权限，数据结构参考[API: permissionInfo](http://api.sensorsdata.cn/?version=v2_sp_115#/%5BSP%5D%20%E8%A7%92%E8%89%B2%E7%AE%A1%E7%90%86/getRoleById) |
| config | `object={isView: false, requireAllChecked: false}` | 配置, isView 表示是否为查看模式; requireAllChecked 表示只有第二列所有权限点选中时，第一列才选中 |
| getDefaultValue | `(id) => any` | 用于获取权限点的默认值 |

```javascript
interface IOption {
    checkable?: boolean, // 是否有选择框
    tooltip?: {
        text: string // 文案
        style: object // 样式
         
    }
    logo?: {
       text?: string
       url: string
    }
}
interface IChildren {
    id: number, // 权限 ID
    label: string // 权限文案
    dependId: number // 依赖的权限 ID
    option?: IOption
}
interface IPermission {
    name: string, // 组名
    cname: string, // 组显示名
    option?: IOption,
    children?: IChildren[]
}
type permissionList = IPermission[]
```

##### mapUiToApi(currentPermissionList)
UI 数据转换为 API 数据

| 参数 | 值类型 | 描述 |
| :-- | :-- | :-- |
| currentPermissionList | `object` | 所有权限 |

```javascript
interface IOption {
    checkable?: boolean, // 是否有选择框
    tooltip?: {
        text: string // 文案
        style: object // 样式
         
    }
    logo?: {
       text?: string
       url: string
    }
}
interface IChildren {
    id: number, // 权限 ID
    label: string // 权限文案
    value?: object // 权限值
    dependId: number // 依赖的权限 ID
    hasPermission?: boolean // 是否被选中
    option?: IOption
}
interface IPermission {
    name: string, // 组名
    cname: string, // 组显示名
    checked?: boolean, // 是否有权限
    option?: IOption,
    children?: IChildren[]
}
type currentPermissionList = IPermission[]
```
