import produce from 'immer';
import creator from '../src/permissionCreator';
import _ from 'lodash';

describe('将 API 数据转换为 UI 数据', () => {
  // 完整权限列表
  const permissonList = [
    {
      name: 'data',
      cname: '数据权限',
      children: [
        {
          id: 1,
          label: '可查看事件',
        },
        {
          id: 2,
          label: '可查看数据',
        },
      ],
    },
    {
      name: 'user_tag',
      cname: '用户标签',
      children: [
        {
          id: 2001,
          label: '可查看',
        },
        {
          id: 2002,
          label: '可编辑',
          option: {
            checkable: true,
          },
        },
      ],
    },
  ];
  // 角色权限
  const rolePermission = {
    event_filter: {
      filter: {},
    },
    user_filter: {
      filter: {},
    },
    permissions: [
      {
        operation_id: 2001,
        resource_id: [],
      },
      {
        operation_id: 2002,
        resource_id: [],
      },
    ],
  };

  let format = () => {};

  beforeAll(() => {
    const formatCreator = creator();
    format = formatCreator[0];
  });

  test('权限列表生成', () => {
    const expectResult = [
      {
        name: 'data',
        cname: '数据权限',
        children: [
          {
            id: 1,
            label: '可查看事件',
          },
          {
            id: 2,
            label: '可查看数据',
          },
        ],
        checked: false,
      },
      {
        name: 'user_tag',
        cname: '用户标签',
        children: [
          {
            id: 2001,
            label: '可查看',
          },
          {
            id: 2002,
            label: '可编辑',
            option: {
              checkable: true,
            },
          },
        ],
        checked: false,
      },
    ];

    expect(format(permissonList)).toEqual(expectResult);
  });

  test('权限列表生成(无角色权限 + 查看模式)', () => {
    const expectResult = [];
    expect(format(permissonList, {}, { isView: true })).toEqual(expectResult);
  });

  test('权限列表生成(含角色权限)', () => {
    const expectResult = [
      {
        name: 'data',
        cname: '数据权限',
        children: [
          {
            id: 1,
            label: '可查看事件',
          },
          {
            id: 2,
            label: '可查看数据',
          },
        ],
        checked: false,
      },
      {
        name: 'user_tag',
        cname: '用户标签',
        children: [
          {
            id: 2001,
            label: '可查看',
            hasPermission: true,
            value: {
              operation_id: 2001,
              resource_id: [],
            },
          },
          {
            id: 2002,
            label: '可编辑',
            option: {
              checkable: true,
            },
            hasPermission: true,
            value: {
              operation_id: 2002,
              resource_id: [],
            },
          },
        ],
        checked: true,
      },
    ];
    expect(format(permissonList, rolePermission)).toEqual(expectResult);
  });

  test('权限列表生成(角色权限 + 数据权限映射)', () => {
    const permissionMap = {
      1: 'event_filter',
      2: ['0123', 'user_filter', 'event_filter'],
    };
    const rolePermission = {
      event_filter: {
        filter: {},
      },
      user_filter: {
        filter: {},
      },
      permissions: [
        {
          operation_id: 2001,
          resource_id: [],
        },
      ],
    };
    const expectResult = [
      {
        name: 'data',
        cname: '数据权限',
        checked: true,
        children: [
          {
            id: 1,
            label: '可查看事件',
            value: {
              event_filter: rolePermission['event_filter'],
            },
            hasPermission: true,
          },
          {
            id: 2,
            label: '可查看数据',
            value: {
              user_filter: rolePermission['user_filter'],
              event_filter: rolePermission['event_filter'],
            },
            hasPermission: true,
          },
        ],
      },
      {
        name: 'user_tag',
        cname: '用户标签',
        checked: true,
        children: [
          {
            id: 2001,
            label: '可查看',
            hasPermission: true,
            value: {
              operation_id: 2001,
              resource_id: [],
            },
          },
          {
            id: 2002,
            label: '可编辑',
            option: {
              checkable: true,
            },
          },
        ],
      },
    ];

    const format = creator(permissionMap)[0];
    expect(format(permissonList, rolePermission)).toEqual(expectResult);
  });

  test('权限列表生成(报错)', () => {
    const permissionMap = {
      1: 'event_filter',
      2: 1,
    };
    const format = creator(permissionMap)[0];
    expect(() => format(permissonList, rolePermission)).toThrow();
  });

  test('权限列表生成(查看模式)', () => {
    const newList = produce(permissonList, permissonList => {
      permissonList[0].option = {};
    });
    const permissionMap = {
      1: 'event_filter',
      2: ['0123', 'user_filter', 'event_filter'],
    };
    const rolePermission = {
      event_filter: {
        filter: {},
      },
      user_filter: {
        filter: {},
      },
      permissions: [
        {
          operation_id: 2002,
          resource_id: [],
        },
      ],
    };
    const expectResult = [
      {
        name: 'data',
        cname: '数据权限',
        checked: true,
        children: [
          {
            id: 1,
            label: '可查看事件',
            value: {
              event_filter: rolePermission['event_filter'],
            },
            hasPermission: true,
          },
          {
            id: 2,
            label: '可查看数据',
            value: {
              user_filter: rolePermission['user_filter'],
              event_filter: rolePermission['event_filter'],
            },
            hasPermission: true,
          },
        ],
      },
      {
        name: 'user_tag',
        cname: '用户标签',
        checked: true,
        children: [
          {
            id: 2002,
            label: '可编辑',
            hasPermission: true,
            value: {
              operation_id: 2002,
              resource_id: [],
            },
          },
        ],
      },
    ];

    const format = creator(permissionMap)[0];
    expect(format(newList, rolePermission, { isView: true })).toEqual(
      expectResult
    );
  });
  test('权限列表生成(默认数据)', () => {
    const newList = produce(permissonList, list => {
      _.set(list, [0, 'children', 0, 'defaultValue'], { id: 10 });
    });
    const expectResult = produce(permissonList, list => {
      _.set(list, [0, 'checked'], true);
      _.set(list, [1, 'checked'], false);
      _.set(list, [0, 'children', 0, 'value'], { id: 10 });
      _.set(list, [0, 'children', 0, 'hasPermission'], true);
    });
    expect(format(newList)).toEqual(expectResult);
  });
  test('权限列表生成(rolePermission 中未包含 dataPermissionMap 权限值)', () => {
    const permissionList = [
      {
        name: 'DATA_QUALITY',
        cname: '数据质量',
        children: [
          { id: '8021', label: '埋点数据查询', option: { checkable: true } },
          { id: '8022', label: '数据校验', option: { checkable: true } },
          { id: '8023', label: '数据流看板', option: { checkable: true } },
          { id: '8024', label: '异常报警', option: { checkable: true } },
        ],
      },
      {
        name: 'DATA_PERMISSION',
        cname: '数据权限',
        option: {
          tooltip: {
            text:
              '「数据权限」指用户可以查看的事件和用户的数据范围，授权将对所有分析模型、用户标签的结果生效。例如：有部分成员，只需要查看实际地理位置在北京且女性用户发生的数据。那么可以在此进行如下设置：事件属性「地理位置 等于 北京」 并且 设置用户属性「性别 等于 女」',
          },
        },
        children: [
          { id: '1', label: '查看', option: { checkable: true } },
          { id: '2', label: '加密用户属性', option: { checkable: true } },
          { id: '3', label: '加密事件属性', option: { checkable: true } },
          { id: '1000', label: '可用事件', option: { checkable: true } },
          { id: '1013', label: '可用事件属性', option: { checkable: true } },
          { id: '1014', label: '可用用户属性', option: { checkable: true } },
        ],
      },
      {
        name: 'MEMBER_MANAGEMENT',
        cname: '成员管理',
        children: [
          { id: '1035', label: '创建账号', option: { checkable: true } },
          { id: '1031', label: '管理成员', option: { checkable: true } },
          { id: '1036', label: '可分配角色', option: { checkable: true } },
        ],
      },
      {
        name: 'ROLE_MANAGEMENT',
        cname: '角色管理',
        children: [
          { id: '1032', label: '角色权限', option: { checkable: true } },
        ],
      },
      {
        name: 'GLOBAL_INFORMATION',
        cname: '全局信息',
        children: [
          {
            id: '11001',
            label: '查看企业基本信息',
            option: { checkable: true },
          },
          {
            id: '11002',
            label: '查看完整的 license 授权内容',
            option: { checkable: true },
          },
          { id: '11003', label: '在线升级', option: { checkable: true } },
        ],
      },
      {
        name: 'PROJECT_MANAGEMENT',
        cname: '项目管理',
        children: [
          { id: '11011', label: '查看项目列表', option: { checkable: true } },
          {
            id: '11012',
            label: '查看项目基本信息',
            option: { checkable: true },
          },
          { id: '11013', label: '更新授权', option: { checkable: true } },
          { id: '1034', label: '重制项目', option: { checkable: true } },
        ],
      },
      {
        name: 'PLATFORM_SETING',
        cname: '平台设置',
        children: [
          { id: '11021', label: '可使用平台设置', option: { checkable: true } },
        ],
      },
    ];
    const dataPermissionMap = {
      '1': ['event_filter', 'profile_filter', 'access_data'],
      '2': ['relation_permissions'],
      '3': ['relation_permissions'],
    };
    const rolePermission = {
      access_data: true,
      event_filter: null,
      permissions: [
        { operation_id: '8011' },
        {
          operation_id: '4005',
          resource_condition: { relation: 'DENY', resource_id_set: [] },
        },
        {
          operation_id: '4101',
          resource_condition: { relation: 'DENY', resource_id_set: [] },
        },
        {
          operation_id: '4301',
          resource_condition: { relation: 'DENY', resource_id_set: [] },
        },
        { operation_id: '4306' },
        { operation_id: '4308' },
        { operation_id: '4311' },
        { operation_id: '4314' },
        {
          operation_id: '4315',
          resource_condition: { relation: 'DENY', resource_id_set: [] },
        },
        { operation_id: '4401' },
        { operation_id: '4407' },
        { operation_id: '4901' },
        { operation_id: '4904' },
        { operation_id: '4907' },
        { operation_id: '1025' },
        {
          operation_id: '2000',
          resource_condition: { relation: 'ALLOW', resource_id_set: [] },
        },
        { operation_id: '1027' },
      ],
      profile_filter: null,
    };
    const expectResult = [
      {
        name: 'DATA_QUALITY',
        cname: '数据质量',
        children: [
          {
            id: '8021',
            label: '埋点数据查询',
            option: {
              checkable: true,
            },
          },
          {
            id: '8022',
            label: '数据校验',
            option: {
              checkable: true,
            },
          },
          {
            id: '8023',
            label: '数据流看板',
            option: {
              checkable: true,
            },
          },
          {
            id: '8024',
            label: '异常报警',
            option: {
              checkable: true,
            },
          },
        ],
        checked: false,
      },
      {
        name: 'DATA_PERMISSION',
        cname: '数据权限',
        option: {
          tooltip: {
            text:
              '「数据权限」指用户可以查看的事件和用户的数据范围，授权将对所有分析模型、用户标签的结果生效。例如：有部分成员，只需要查看实际地理位置在北京且女性用户发生的数据。那么可以在此进行如下设置：事件属性「地理位置 等于 北京」 并且 设置用户属性「性别 等于 女」',
          },
        },
        children: [
          {
            id: '1',
            label: '查看',
            option: {
              checkable: true,
            },
            hasPermission: true,
            value: {
              event_filter: null,
              profile_filter: null,
              access_data: true,
            },
          },
          {
            id: '2',
            label: '加密用户属性',
            option: {
              checkable: true,
            },
          },
          {
            id: '3',
            label: '加密事件属性',
            option: {
              checkable: true,
            },
          },
          {
            id: '1000',
            label: '可用事件',
            option: {
              checkable: true,
            },
          },
          {
            id: '1013',
            label: '可用事件属性',
            option: {
              checkable: true,
            },
          },
          {
            id: '1014',
            label: '可用用户属性',
            option: {
              checkable: true,
            },
          },
        ],
        checked: true,
      },
      {
        name: 'MEMBER_MANAGEMENT',
        cname: '成员管理',
        children: [
          {
            id: '1035',
            label: '创建账号',
            option: {
              checkable: true,
            },
          },
          {
            id: '1031',
            label: '管理成员',
            option: {
              checkable: true,
            },
          },
          {
            id: '1036',
            label: '可分配角色',
            option: {
              checkable: true,
            },
          },
        ],
        checked: false,
      },
      {
        name: 'ROLE_MANAGEMENT',
        cname: '角色管理',
        children: [
          {
            id: '1032',
            label: '角色权限',
            option: {
              checkable: true,
            },
          },
        ],
        checked: false,
      },
      {
        name: 'GLOBAL_INFORMATION',
        cname: '全局信息',
        children: [
          {
            id: '11001',
            label: '查看企业基本信息',
            option: {
              checkable: true,
            },
          },
          {
            id: '11002',
            label: '查看完整的 license 授权内容',
            option: {
              checkable: true,
            },
          },
          {
            id: '11003',
            label: '在线升级',
            option: {
              checkable: true,
            },
          },
        ],
        checked: false,
      },
      {
        name: 'PROJECT_MANAGEMENT',
        cname: '项目管理',
        children: [
          {
            id: '11011',
            label: '查看项目列表',
            option: {
              checkable: true,
            },
          },
          {
            id: '11012',
            label: '查看项目基本信息',
            option: {
              checkable: true,
            },
          },
          {
            id: '11013',
            label: '更新授权',
            option: {
              checkable: true,
            },
          },
          {
            id: '1034',
            label: '重制项目',
            option: {
              checkable: true,
            },
          },
        ],
        checked: false,
      },
      {
        name: 'PLATFORM_SETING',
        cname: '平台设置',
        children: [
          {
            id: '11021',
            label: '可使用平台设置',
            option: {
              checkable: true,
            },
          },
        ],
        checked: false,
      },
    ];
    const format = creator(dataPermissionMap)[0];
    expect(format(permissionList, rolePermission)).toEqual(expectResult);
  });
});

describe('将 UI 数据转换为 API 数据', () => {
  // 角色权限
  const rolePermission = {
    event_filter: {
      filter: {},
    },
    user_filter: {
      filter: {},
    },
    permissions: [
      {
        operation_id: 2001,
        resource_id: [],
      },
      {
        operation_id: 2002,
        resource_id: [],
      },
    ],
  };
  // 当前权限列表
  const permissonList = [
    {
      name: 'data',
      cname: '数据权限',
      children: [
        {
          id: 1,
          label: '可查看事件',
          value: {
            event_filter: rolePermission['event_filter'],
          },
        },
        {
          id: 2,
          label: '可查看数据',
          value: {
            user_filter: rolePermission['user_filter'],
            '0123': {},
            event_filter: rolePermission['event_filter'],
          },
        },
      ],
    },
    {
      name: 'user_tag',
      cname: '用户标签',
      children: [
        {
          id: 2001,
          label: '可查看',
        },
        {
          id: 2002,
          label: '可编辑',
          value: {
            operation_id: 2002,
            resource_id: [],
          },
        },
      ],
    },
  ];
  const permissionMap = {
    1: 'event_filter',
    2: ['0123', 'user_filter'],
  };
  let format = () => {};
  beforeAll(() => {
    format = creator(permissionMap)[1];
  });
  test('权限都未选中', () => {
    const expectData = {
      event_filter: rolePermission['event_filter'],
      user_filter: rolePermission['user_filter'],
      '0123': null,
      permissions: [
        {
          operation_id: 2001,
        },
        {
          operation_id: 2002,
          resource_id: [],
        },
      ],
    };
    expect(format(permissonList)).toEqual(expectData);
  });
  test('权限映射(数据权限 + 功能权限)', () => {
    const currentPermissionList = produce(permissonList, permissonList => {
      permissonList.forEach(item => {
        item.children.forEach(child => {
          child.hasPermission = true;
          if (child.id === 2) {
            child.value['0123'] = false;
          }
        });
      });
    });
    const expectData = {
      event_filter: rolePermission['event_filter'],
      user_filter: rolePermission['user_filter'],
      '0123': false,
      permissions: [
        {
          operation_id: 2001,
        },
        {
          operation_id: 2002,
          resource_id: [],
        },
      ],
    };
    expect(format(currentPermissionList)).toEqual(expectData);
  });

  test('传入 getDefaultValue：', () => {
    const DEFAULT_VALUE = 'DEFAULT VALUE';
    const permissionList = [
      {
        name: 'ROLE_MANAGEMENT',
        cname: '角色管理',
        children: [
          { id: '1032', label: '角色权限', option: { checkable: true } },
        ],
      },
    ];
    const dataPermissionMap = {
      '1': ['event_filter', 'profile_filter', 'access_data'],
      '2': ['relation_permissions'],
      '3': ['relation_permissions'],
    };
    const rolePermission = {
      access_data: true,
      event_filter: null,
      permissions: [],
      profile_filter: null,
    };
    const expectResult = [
      {
        name: 'ROLE_MANAGEMENT',
        cname: '角色管理',
        children: [
          {
            id: '1032',
            label: '角色权限',
            option: {
              checkable: true,
            },
            value: DEFAULT_VALUE
          },
        ],
        checked: false,
      },
    ];
    const format = creator(dataPermissionMap)[0];
    const result = format(permissionList, rolePermission, {
      isView: false
    }, () => DEFAULT_VALUE);
    expect(result).toEqual(expectResult);
  });
});
